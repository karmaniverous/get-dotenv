<!DOCTYPE html><html class="default" lang="en" data-base="../"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>Executing Shell Commands | @karmaniverous/get-dotenv</title><meta name="description" content="Documentation for @karmaniverous/get-dotenv"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="../index.html" class="title">@karmaniverous/get-dotenv</a><div id="tsd-toolbar-links"><a href="https://github.com/karmaniverous/get-dotenv">GitHub</a></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb" aria-label="Breadcrumb"><li><a href="Guides.html">Guides</a></li><li><a href="Guides.Authoring_Plugins.html">Authoring Plugins</a></li><li><a href="" aria-current="page">Executing Shell Commands</a></li></ul></div><div class="tsd-panel tsd-typography"><h1 id="authoring-plugins-executing-shell-commands" class="tsd-anchor-link">Authoring Plugins: Executing Shell Commands<a href="#authoring-plugins-executing-shell-commands" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>For an overview of default shells and quoting across platforms, see <a href="Guides.Shell_execution_behavior.html">Shell execution behavior</a>. The host normalizes <code>--shell</code> defaults to <code>/bin/bash</code> on POSIX and <code>powershell.exe</code> on Windows unless explicitly overridden, and CLI‑driven plugins should usually honor the root shell (with rare per‑script overrides).</p>
<p>There are two distinct patterns for plugins that run shell commands:</p>
<ol>
<li>CLI‑driven (cmd/batch‑like): the user types arbitrary commands; a scripts table helps encapsulate frequently used commands.</li>
<li>Tool‑invocation inside a plugin: the plugin calls an external tool (e.g., docker) with env/config‑derived overrides; scripts are typically not relevant.</li>
</ol>
<p>This guide explains expansion timing (including dotenv‑style expansion of CLI flag values and config slices), shell selection, child environment composition, capture/diagnostics, quoting, and safety, with minimal patterns you can copy.</p>
<h2 id="where-expansion-happens" class="tsd-anchor-link">Where expansion happens<a href="#where-expansion-happens" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Config‑derived strings (including plugin config and global scripts) are interpolated by the host before your plugin runs. Interpolation uses dotenv syntax against <code>{ ...ctx.dotenv, ...process.env }</code> (process.env wins), so these values arrive pre‑expanded once. Treat them as final; avoid re‑expanding to prevent surprises.</li>
<li>Runtime inputs (argv/flags you parse): you choose. If you want pre‑expansion, call a dotenv expander once (e.g., <code>dotenvExpandFromProcessEnv</code>); otherwise rely on the shell to expand. Document the behavior so users understand quoting implications.</li>
<li>Built‑in parity note:
<ul>
<li>The parent‑level alias (<code>--cmd 'node -e &quot;…&quot;'</code>) expands the alias value once before execution.</li>
<li>The <code>cmd</code> subcommand’s positional tokens are not pre‑expanded; the shell (or lack of shell) governs expansion.</li>
</ul>
</li>
</ul>
<h3 id="expanding-environment-references-in-plugin-flag-values" class="tsd-anchor-link">Expanding environment references in plugin flag values<a href="#expanding-environment-references-in-plugin-flag-values" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Downstream users of third‑party plugins often want to reference values from the current dotenv context inside command-line option values, for example: <code>getdotenv aws dynamodb migrate --table-name '${TABLE_NAME}'</code>.</p>
<p>Important: the host does not automatically dotenv-expand arbitrary plugin flag values. This differs from config-derived strings (which the host interpolates before your plugin runs using <code>dotenvExpandAll</code>/<code>interpolateDeep</code>) and from selected root flags which explicitly install an <code>argParser</code> (see <a href="../modules/cliHost_attachRootOptions.html"><code>src/cliHost/attachRootOptions.ts</code></a>).</p>
<p>If you want this UX, you must expand the option value yourself, and you should document the quoting rules so users don’t accidentally expand in the outer shell before your plugin sees the raw <code>$VAR</code>/<code>${VAR}</code> expression.</p>
<p>Recommended strategies:</p>
<ul>
<li>Action-time expansion (ctx-aware; recommended): expand using <code>{ ...process.env, ...ctx.dotenv }</code> so the resolved dotenv context takes precedence, and so the behavior does not depend on <code>loadProcess</code> being enabled.</li>
<li>Parse-time expansion (process-only; niche): use <code>.argParser(dotenvExpandFromProcessEnv)</code> only when you explicitly want to expand against the parent process environment. This is the pattern used by the shipped cmd plugin alias expansion in <a href="../modules/plugins_cmd_parentInvoker.html"><code>src/plugins/cmd/parentInvoker.ts</code></a>, and it’s appropriate for “expand with whatever the current process already has” semantics.</li>
</ul>
<h4 id="action-time-expansion-ctx-aware-recommended" class="tsd-anchor-link">Action-time expansion (ctx-aware; recommended)<a href="#action-time-expansion-ctx-aware-recommended" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>This is the most reliable approach for plugins, because it expands against the resolved get-dotenv context even when <code>loadProcess</code> is OFF (which is common for safety).</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">dotenvExpand</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv&#39;</span><span class="hl-1">;</span><br/><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">definePlugin</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv/cliHost&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">export</span><span class="hl-1"> </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-0">dynamodbMigratePlugin</span><span class="hl-1"> = () </span><span class="hl-3">=&gt;</span><br/><span class="hl-1">  </span><span class="hl-0">definePlugin</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-5">ns:</span><span class="hl-1"> </span><span class="hl-2">&#39;migrate&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">setup</span><span class="hl-1">(</span><span class="hl-5">cli</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">cli</span><br/><span class="hl-1">        .</span><span class="hl-0">requiredOption</span><span class="hl-1">(</span><br/><span class="hl-1">          </span><span class="hl-2">&#39;--table-name &lt;string&gt;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-2">&#39;DynamoDB table name (dotenv-expanded against ctx.dotenv)&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        )</span><br/><span class="hl-1">        .</span><span class="hl-0">action</span><span class="hl-1">((</span><span class="hl-5">_args</span><span class="hl-1">, </span><span class="hl-5">opts</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">ctx</span><span class="hl-1"> = </span><span class="hl-5">cli</span><span class="hl-1">.</span><span class="hl-0">getCtx</span><span class="hl-1">();</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">raw</span><span class="hl-1"> = </span><span class="hl-0">String</span><span class="hl-1">((</span><span class="hl-5">opts</span><span class="hl-1"> </span><span class="hl-4">as</span><span class="hl-1"> { </span><span class="hl-5">tableName</span><span class="hl-1">?: </span><span class="hl-14">unknown</span><span class="hl-1"> }).</span><span class="hl-5">tableName</span><span class="hl-1"> ?? </span><span class="hl-2">&#39;&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">          </span><span class="hl-7">// Prefer ctx-aware expansion: ctx.dotenv overrides parent process.env.</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">expanded</span><span class="hl-1"> =</span><br/><span class="hl-1">            </span><span class="hl-0">dotenvExpand</span><span class="hl-1">(</span><span class="hl-5">raw</span><span class="hl-1">, { ...</span><span class="hl-5">process</span><span class="hl-1">.</span><span class="hl-5">env</span><span class="hl-1">, ...</span><span class="hl-5">ctx</span><span class="hl-1">.</span><span class="hl-5">dotenv</span><span class="hl-1"> }) ?? </span><span class="hl-5">raw</span><span class="hl-1">;</span><br/><br/><span class="hl-1">          </span><span class="hl-4">if</span><span class="hl-1"> (!</span><span class="hl-5">expanded</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-4">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><br/><span class="hl-1">              </span><span class="hl-2">&#39;Missing --table-name (or it expanded to an empty string). &#39;</span><span class="hl-1"> +</span><br/><span class="hl-1">                </span><span class="hl-2">&quot;If you intended to reference an env var, pass it as &#39;${NAME}&#39; and ensure NAME exists in the resolved dotenv context.&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">            );</span><br/><span class="hl-1">          }</span><br/><br/><span class="hl-1">          </span><span class="hl-7">// Use expanded value (do not re-expand config-derived strings here)</span><br/><span class="hl-1">          </span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`migrating table=</span><span class="hl-3">${</span><span class="hl-5">expanded</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  });</span>
</code><button type="button">Copy</button></pre>

<p>Notes:</p>
<ul>
<li><code>dotenvExpand</code> is implemented in <a href="../modules/dotenv_dotenvExpand.html"><code>src/dotenv/dotenvExpand.ts</code></a>.</li>
<li><code>dotenvExpand('$MISSING')</code> returns <code>undefined</code> (isolated missing var), while embedded missing vars usually collapse to <code>''</code> inside a larger string. Decide whether your plugin should treat “missing” as an error (recommended for required flags) or as a best-effort expansion.</li>
<li>If you want a default/fallback value, document the supported syntax to your users: <code>${NAME:default}</code> (or <code>$NAME:default</code>).</li>
</ul>
<h4 id="using-dotenvexpand-as-an-option-parser-when-it-is-and-isnt-appropriate" class="tsd-anchor-link">Using dotenvExpand as an option parser (when it is and isn’t appropriate)<a href="#using-dotenvexpand-as-an-option-parser-when-it-is-and-isnt-appropriate" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Commander lets you attach a parser to an option:</p>
<pre><code class="ts"><span class="hl-5">cli</span><span class="hl-1">.</span><span class="hl-0">option</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-2">&#39;--name &lt;string&gt;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-2">&#39;example&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  (</span><span class="hl-5">value</span><span class="hl-1">: </span><span class="hl-14">string</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-5">value</span><span class="hl-1">.</span><span class="hl-0">trim</span><span class="hl-1">(), </span><span class="hl-7">// parser</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>You can wire a dotenv expander there, but it is important to understand <strong>what env it runs against and when</strong>:</p>
<ul>
<li>Parsers run at <strong>parse time</strong>, before the host resolves the dotenv context or calls <code>resolveAndLoad</code>.</li>
<li>The default <code>dotenvExpand(value)</code> uses <strong><code>process.env</code> only</strong>, not <code>{ ...process.env, ...ctx.dotenv }</code>.</li>
</ul>
<p>This means:</p>
<ul>
<li><code>cli.option('--table-name &lt;string&gt;', '...', dotenvExpand)</code> expands against the parent process env, not the resolved get‑dotenv context.</li>
<li>You cannot make a parser see <code>ctx.dotenv</code>, because <code>ctx</code> does not exist yet while Commander is parsing argv.</li>
</ul>
<p>This behavior is sometimes exactly what you want, but only in <strong>niche, process‑only cases</strong>.</p>
<p>Recommended guidelines:</p>
<ul>
<li>
<p>For <strong>root‑level, process‑only flags</strong> (like the shipped cmd parent alias), it is fine to use <code>dotenvExpandFromProcessEnv</code> in a parser:</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">dotenvExpandFromProcessEnv</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-5">parentCmd</span><br/><span class="hl-1">  .</span><span class="hl-0">option</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;--cmd &lt;command...&gt;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">&#39;alias of cmd subcommand (dotenv-expanded against process.env)&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  )</span><br/><span class="hl-1">  .</span><span class="hl-0">argParser</span><span class="hl-1">(</span><span class="hl-5">dotenvExpandFromProcessEnv</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>This clearly states the semantics: “expand with whatever is in <code>process.env</code> right now,” and matches the shipped behavior.</p>
</li>
<li>
<p>For <strong>plugin options that should see the resolved dotenv context</strong>, <strong>do not</strong> use <code>dotenvExpand</code> as a parser. Instead, expand at action time against <code>{ ...process.env, ...ctx.dotenv }</code> as shown earlier:</p>
<pre><code class="ts"><span class="hl-5">cli</span><br/><span class="hl-1">  .</span><span class="hl-0">ns</span><span class="hl-1">(</span><span class="hl-2">&#39;migrate&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">requiredOption</span><span class="hl-1">(</span><span class="hl-2">&#39;--table-name &lt;string&gt;&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;DynamoDB table name&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">action</span><span class="hl-1">((</span><span class="hl-5">_args</span><span class="hl-1">, </span><span class="hl-5">opts</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">ctx</span><span class="hl-1"> = </span><span class="hl-5">cli</span><span class="hl-1">.</span><span class="hl-0">getCtx</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">raw</span><span class="hl-1"> = </span><span class="hl-0">String</span><span class="hl-1">((</span><span class="hl-5">opts</span><span class="hl-1"> </span><span class="hl-4">as</span><span class="hl-1"> { </span><span class="hl-5">tableName</span><span class="hl-1">?: </span><span class="hl-14">unknown</span><span class="hl-1"> }).</span><span class="hl-5">tableName</span><span class="hl-1"> ?? </span><span class="hl-2">&#39;&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">envRef</span><span class="hl-1"> = { ...</span><span class="hl-5">process</span><span class="hl-1">.</span><span class="hl-5">env</span><span class="hl-1">, ...</span><span class="hl-5">ctx</span><span class="hl-1">.</span><span class="hl-5">dotenv</span><span class="hl-1"> };</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">expanded</span><span class="hl-1"> = </span><span class="hl-0">dotenvExpand</span><span class="hl-1">(</span><span class="hl-5">raw</span><span class="hl-1">, </span><span class="hl-5">envRef</span><span class="hl-1">) ?? </span><span class="hl-5">raw</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-7">// ...</span><br/><span class="hl-1">  });</span>
</code><button type="button">Copy</button></pre>

<p>This keeps behavior independent of <code>loadProcess</code> and ensures plugin flags see the same composed env your subprocess will receive.</p>
</li>
</ul>
<p>In short:</p>
<ul>
<li><strong>Parse‑time expansion</strong> with <code>.argParser(dotenvExpandFromProcessEnv)</code> is appropriate only when you intentionally want “process‑only” semantics and you document that clearly.</li>
<li><strong>Action‑time expansion</strong> with <code>dotenvExpand(value, { ...process.env, ...ctx.dotenv })</code> is the right choice for most plugins, because it is ctx‑aware and runs after the host has built the final dotenv context.</li>
</ul>
<h5 id="small-reusable-helper-docs-pattern" class="tsd-anchor-link">Small reusable helper (docs pattern)<a href="#small-reusable-helper-docs-pattern" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h5><p>If you have multiple options that should support <code>${NAME}</code>-style expansion, consider a tiny helper for your plugin:</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">dotenvExpand</span><span class="hl-1">, </span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-5">ProcessEnv</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv&#39;</span><span class="hl-1">;</span><br/><span class="hl-4">import</span><span class="hl-1"> </span><span class="hl-4">type</span><span class="hl-1"> { </span><span class="hl-5">GetDotenvCliPublic</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv/cliHost&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-14">ExpandMode</span><span class="hl-1"> = </span><span class="hl-2">&#39;strict&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;best-effort&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">function</span><span class="hl-1"> </span><span class="hl-0">expandFlagValue</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-5">cli</span><span class="hl-1">: </span><span class="hl-14">GetDotenvCliPublic</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">raw</span><span class="hl-1">: </span><span class="hl-14">unknown</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">mode</span><span class="hl-1">: </span><span class="hl-14">ExpandMode</span><span class="hl-1">,</span><br/><span class="hl-1">): </span><span class="hl-14">string</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">value</span><span class="hl-1"> = </span><span class="hl-0">String</span><span class="hl-1">(</span><span class="hl-5">raw</span><span class="hl-1"> ?? </span><span class="hl-2">&#39;&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">  </span><span class="hl-4">if</span><span class="hl-1"> (!</span><span class="hl-5">value</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">mode</span><span class="hl-1"> === </span><span class="hl-2">&#39;strict&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-4">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&#39;Required flag value is empty.&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">value</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">ctx</span><span class="hl-1"> = </span><span class="hl-5">cli</span><span class="hl-1">.</span><span class="hl-0">getCtx</span><span class="hl-1">();</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">envRef</span><span class="hl-1">: </span><span class="hl-14">ProcessEnv</span><span class="hl-1"> = { ...</span><span class="hl-5">process</span><span class="hl-1">.</span><span class="hl-5">env</span><span class="hl-1">, ...</span><span class="hl-5">ctx</span><span class="hl-1">.</span><span class="hl-5">dotenv</span><span class="hl-1"> };</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">expanded</span><span class="hl-1"> = </span><span class="hl-0">dotenvExpand</span><span class="hl-1">(</span><span class="hl-5">value</span><span class="hl-1">, </span><span class="hl-5">envRef</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">expanded</span><span class="hl-1"> === </span><span class="hl-3">undefined</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">if</span><span class="hl-1"> (</span><span class="hl-5">mode</span><span class="hl-1"> === </span><span class="hl-2">&#39;strict&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-4">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-2">`Flag value </span><span class="hl-3">${</span><span class="hl-6">JSON</span><span class="hl-13">.</span><span class="hl-0">stringify</span><span class="hl-13">(</span><span class="hl-5">value</span><span class="hl-13">)</span><span class="hl-3">}</span><span class="hl-2"> could not be expanded: `</span><span class="hl-1"> +</span><br/><span class="hl-1">          </span><span class="hl-2">&#39;referenced an unset variable with no default. &#39;</span><span class="hl-1"> +</span><br/><span class="hl-1">          </span><span class="hl-2">&quot;Use &#39;${NAME:default}&#39; to supply a fallback, or ensure NAME exists &quot;</span><span class="hl-1"> +</span><br/><span class="hl-1">          </span><span class="hl-2">&#39;in the resolved dotenv context.&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">      );</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-7">// best-effort: keep original when fully-unresolved</span><br/><span class="hl-1">    </span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">value</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-4">if</span><span class="hl-1"> (!</span><span class="hl-5">expanded</span><span class="hl-1"> &amp;&amp; </span><span class="hl-5">mode</span><span class="hl-1"> === </span><span class="hl-2">&#39;strict&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><br/><span class="hl-1">      </span><span class="hl-2">`Flag value </span><span class="hl-3">${</span><span class="hl-6">JSON</span><span class="hl-13">.</span><span class="hl-0">stringify</span><span class="hl-13">(</span><span class="hl-5">value</span><span class="hl-13">)</span><span class="hl-3">}</span><span class="hl-2"> expanded to an empty string.`</span><span class="hl-1">,</span><br/><span class="hl-1">    );</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">expanded</span><span class="hl-1">;</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<p>Usage inside a plugin action:</p>
<pre><code class="ts"><span class="hl-5">cli</span><br/><span class="hl-1">  .</span><span class="hl-0">ns</span><span class="hl-1">(</span><span class="hl-2">&#39;migrate&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">requiredOption</span><span class="hl-1">(</span><span class="hl-2">&#39;--table-name &lt;string&gt;&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;DynamoDB table name&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">option</span><span class="hl-1">(</span><span class="hl-2">&#39;--schema &lt;string&gt;&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;optional schema name&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">  .</span><span class="hl-0">action</span><span class="hl-1">((</span><span class="hl-5">_args</span><span class="hl-1">, </span><span class="hl-5">opts</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">tableName</span><span class="hl-1"> = </span><span class="hl-0">expandFlagValue</span><span class="hl-1">(</span><span class="hl-5">cli</span><span class="hl-1">, (</span><span class="hl-5">opts</span><span class="hl-1"> </span><span class="hl-4">as</span><span class="hl-1"> </span><span class="hl-14">any</span><span class="hl-1">).</span><span class="hl-5">tableName</span><span class="hl-1">, </span><span class="hl-2">&#39;strict&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">schema</span><span class="hl-1"> = </span><span class="hl-0">expandFlagValue</span><span class="hl-1">(</span><span class="hl-5">cli</span><span class="hl-1">, (</span><span class="hl-5">opts</span><span class="hl-1"> </span><span class="hl-4">as</span><span class="hl-1"> </span><span class="hl-14">any</span><span class="hl-1">).</span><span class="hl-5">schema</span><span class="hl-1">, </span><span class="hl-2">&#39;best-effort&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">({ </span><span class="hl-5">tableName</span><span class="hl-1">, </span><span class="hl-5">schema</span><span class="hl-1"> });</span><br/><span class="hl-1">  });</span>
</code><button type="button">Copy</button></pre>

<p>Notes:</p>
<ul>
<li>This pattern is docs-only; it is not shipped as a helper today, but you can copy/paste and adapt it inside your plugin package.</li>
<li><code>strict</code> vs <code>best-effort</code> is per-call, so you can require certain flags to expand cleanly while letting others be more forgiving.</li>
</ul>
<h5 id="arrays-and-deep-structures-" class="tsd-anchor-link">Arrays and deep structures: <code>dotenvExpandAll</code> + <code>interpolateDeep</code><a href="#arrays-and-deep-structures-" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h5><p>For simple scalars, <code>dotenvExpand</code> is enough. For more complex data:</p>
<ul>
<li>Use <code>dotenvExpandAll</code> when you have a flat <code>ProcessEnv</code>, e.g., a small env-like map.</li>
<li>Use <code>interpolateDeep</code> when you have nested objects (e.g., plugin config slices) and want to expand only string leaves while preserving non-strings and arrays.</li>
</ul>
<p>Both are exported from the public API:</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">dotenvExpandAll</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">interpolateDeep</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-5">ProcessEnv</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">envRef</span><span class="hl-1">: </span><span class="hl-14">ProcessEnv</span><span class="hl-1"> = { ...</span><span class="hl-5">process</span><span class="hl-1">.</span><span class="hl-5">env</span><span class="hl-1">, ...</span><span class="hl-5">ctx</span><span class="hl-1">.</span><span class="hl-5">dotenv</span><span class="hl-1"> };</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">flat</span><span class="hl-1"> = </span><span class="hl-0">dotenvExpandAll</span><span class="hl-1">(</span><br/><span class="hl-1">  { </span><span class="hl-5">TABLE:</span><span class="hl-1"> </span><span class="hl-2">&#39;${TABLE_NAME}&#39;</span><span class="hl-1">, </span><span class="hl-5">STAGE:</span><span class="hl-1"> </span><span class="hl-2">&#39;$STAGE:dev&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">  {</span><br/><span class="hl-1">    </span><span class="hl-5">ref:</span><span class="hl-1"> </span><span class="hl-5">envRef</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">progressive:</span><span class="hl-1"> </span><span class="hl-3">true</span><span class="hl-1">,</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">deep</span><span class="hl-1"> = </span><span class="hl-0">interpolateDeep</span><span class="hl-1">(</span><br/><span class="hl-1">  { </span><span class="hl-5">migrations:</span><span class="hl-1"> [{ </span><span class="hl-5">table:</span><span class="hl-1"> </span><span class="hl-2">&#39;${TABLE_NAME}&#39;</span><span class="hl-1">, </span><span class="hl-5">region:</span><span class="hl-1"> </span><span class="hl-2">&#39;$AWS_REGION&#39;</span><span class="hl-1"> }] },</span><br/><span class="hl-1">  </span><span class="hl-5">envRef</span><span class="hl-1">,</span><br/><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h4 id="cli-usage-examples-and-quoting-portable" class="tsd-anchor-link">CLI usage examples and quoting (portable)<a href="#cli-usage-examples-and-quoting-portable" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Preferred (portable across shells): quote the expression so the <em>outer shell</em> does not expand it before your plugin sees it.</p>
<pre><code class="bash"><span class="hl-7"># Expand from the resolved get-dotenv context inside the plugin</span><br/><span class="hl-0">getdotenv</span><span class="hl-1"> </span><span class="hl-2">aws</span><span class="hl-1"> </span><span class="hl-2">dynamodb</span><span class="hl-1"> </span><span class="hl-2">migrate</span><span class="hl-1"> </span><span class="hl-3">--table-name</span><span class="hl-1"> </span><span class="hl-2">&#39;${TABLE_NAME}&#39;</span><br/><br/><span class="hl-7"># Provide a fallback/default at the call site</span><br/><span class="hl-0">getdotenv</span><span class="hl-1"> </span><span class="hl-2">aws</span><span class="hl-1"> </span><span class="hl-2">dynamodb</span><span class="hl-1"> </span><span class="hl-2">migrate</span><span class="hl-1"> </span><span class="hl-3">--table-name</span><span class="hl-1"> </span><span class="hl-2">&#39;${TABLE_NAME:my-table}&#39;</span>
</code><button type="button">Copy</button></pre>

<p>Alternative (outer shell expansion): let the outer shell expand first, and pass the fully expanded value to the plugin. This is less portable, but sometimes convenient.</p>
<pre><code class="bash"><span class="hl-7"># POSIX shells (bash/zsh): $TABLE_NAME is expanded by the shell</span><br/><span class="hl-0">getdotenv</span><span class="hl-1"> </span><span class="hl-2">aws</span><span class="hl-1"> </span><span class="hl-2">dynamodb</span><span class="hl-1"> </span><span class="hl-2">migrate</span><span class="hl-1"> </span><span class="hl-3">--table-name</span><span class="hl-1"> </span><span class="hl-2">&quot;</span><span class="hl-5">$TABLE_NAME</span><span class="hl-2">&quot;</span><br/><br/><span class="hl-7"># PowerShell: use $env:TABLE_NAME for environment variables</span><br/><span class="hl-0">getdotenv</span><span class="hl-1"> </span><span class="hl-2">aws</span><span class="hl-1"> </span><span class="hl-2">dynamodb</span><span class="hl-1"> </span><span class="hl-2">migrate</span><span class="hl-1"> </span><span class="hl-3">--table-name</span><span class="hl-1"> </span><span class="hl-2">&quot;</span><span class="hl-5">$env</span><span class="hl-2">:TABLE_NAME&quot;</span>
</code><button type="button">Copy</button></pre>

<p>If you choose to rely on outer shell expansion, document the shell-specific syntax and quoting differences explicitly; otherwise, prefer the portable dotenv-style <code>${NAME}</code> syntax and expand inside the plugin action.</p>
<h2 id="shell-selection-and-precedence" class="tsd-anchor-link">Shell selection and precedence<a href="#shell-selection-and-precedence" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Plugins should rely on the root shell setting unless a command itself requests a different shell:</p>
<ul>
<li>Root <code>--shell</code> (global) is normalized by the host to a concrete default when enabled:
<ul>
<li>POSIX: <code>/bin/bash</code></li>
<li>Windows: <code>powershell.exe</code></li>
</ul>
</li>
<li>Rare per‑script override: if you offer a scripts table and use the object form <code>{ cmd, shell }</code>, prefer <code>scripts[name].shell</code> over the root shell for that script only. This is appropriate for CLI‑driven, arbitrary‑command plugins (cmd/batch‑like). It is uncommon elsewhere.</li>
<li>Discouraged: a per‑plugin <code>shell</code> option. Use the root shell and the rare per‑script override instead.</li>
</ul>
<p>Recommended precedence (when you support scripts):</p>
<pre><code><span class="hl-5">scripts</span><span class="hl-1">[</span><span class="hl-5">name</span><span class="hl-1">].</span><span class="hl-0">shell</span><span class="hl-1"> (</span><span class="hl-5">object</span><span class="hl-1"> </span><span class="hl-5">form</span><span class="hl-1">; </span><span class="hl-5">when</span><span class="hl-1"> </span><span class="hl-5">omitted</span><span class="hl-1">, </span><span class="hl-5">currently</span><span class="hl-1"> </span><span class="hl-5">forces</span><span class="hl-1"> </span><span class="hl-5">shell</span><span class="hl-1">-</span><span class="hl-5">off</span><span class="hl-1">) &gt; </span><span class="hl-5">root</span><span class="hl-1"> </span><span class="hl-5">bag</span><span class="hl-1">.</span><span class="hl-5">shell</span>
</code><button>Copy</button></pre>

<h2 id="child-environment-composition-required" class="tsd-anchor-link">Child environment composition (required)<a href="#child-environment-composition-required" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Always inject a normalized env into child processes:</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">buildSpawnEnv</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv&#39;</span><span class="hl-1">;</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">childEnv</span><span class="hl-1"> = </span><span class="hl-0">buildSpawnEnv</span><span class="hl-1">(</span><span class="hl-5">process</span><span class="hl-1">.</span><span class="hl-5">env</span><span class="hl-1">, </span><span class="hl-5">ctx</span><span class="hl-1">.</span><span class="hl-5">dotenv</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Benefits:</p>
<ul>
<li>Windows: dedupes case‑insensitive keys, fills HOME from USERPROFILE, normalizes TMP/TEMP.</li>
<li>POSIX: populates TMPDIR when a temp key is present.</li>
</ul>
<h2 id="capture-and-diagnostics" class="tsd-anchor-link">Capture and diagnostics<a href="#capture-and-diagnostics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Honor the shared capture contract for CI‑friendly logs:</p>
<ul>
<li>Use <code>stdio: 'pipe'</code> when <code>process.env.GETDOTENV_STDIO === 'pipe'</code> or the merged root options bag sets <code>capture: true</code>. Otherwise, inherit stdio for live interaction.</li>
<li>Optional, best practice: mirror the cmd plugin’s concise <code>--trace [keys...]</code> lines (origin: dotenv | parent | unset) with presentation‑time redaction for secret‑like keys and once‑per‑key entropy warnings. This is not a requirement but provides a consistent DX.
<ul>
<li>Note: the current <code>runCommand()</code> helper re-emits buffered stdout only when <code>stdio: 'pipe'</code> is used. If you need to reliably print stderr in capture mode, prefer <code>runCommandResult()</code> and write <code>stderr</code> explicitly.</li>
</ul>
</li>
</ul>
<h2 id="quoting-and-argv-vs-string" class="tsd-anchor-link">Quoting and argv vs string<a href="#quoting-and-argv-vs-string" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Shell‑off (plain exec): prefer argv arrays (especially for <code>node -e/--eval</code> payloads) to avoid lossy re‑tokenization and keep code payloads intact.</li>
<li>Shell‑on: pass a single string to the selected shell and document quoting rules:
<ul>
<li>POSIX and PowerShell both treat single quotes as literal and double quotes as interpolating. Recommend single quotes when users want to prevent outer‑shell expansion.</li>
</ul>
</li>
</ul>
<h3 id="preserve-node-argv-under-shelloff" class="tsd-anchor-link">Preserve Node <code>-e/--eval</code> argv under shell‑off<a href="#preserve-node-argv-under-shelloff" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><p>When executing a plain <code>node -e</code> snippet without a shell, preserve the argv array so code payloads remain intact across platforms (especially Windows/PowerShell). The host exports a small helper for this:</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">maybePreserveNodeEvalArgv</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv/cliHost&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-7">// args = [&#39;node&#39;, &#39;-e&#39;, &#39;console.log(&quot;ok&quot;)&#39;, ...]</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">argv</span><span class="hl-1"> = </span><span class="hl-0">maybePreserveNodeEvalArgv</span><span class="hl-1">(</span><span class="hl-5">args</span><span class="hl-1">);</span><br/><span class="hl-7">// pass argv directly to execa(...)</span>
</code><button type="button">Copy</button></pre>

<h2 id="doubleexpansion-and-safety" class="tsd-anchor-link">Double‑expansion and safety<a href="#doubleexpansion-and-safety" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>Config strings are already interpolated once by the host. Do not re‑expand them in your plugin. If you need a late expansion step, do it exactly once and document it.</li>
<li>Prefer env injection over in‑line secrets in command text to avoid leaking secrets via logs or process lists.</li>
</ul>
<h2 id="minimal-patterns" class="tsd-anchor-link">Minimal patterns<a href="#minimal-patterns" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="toolinvocation-no-scripts" class="tsd-anchor-link">Tool‑invocation (no scripts)<a href="#toolinvocation-no-scripts" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">buildSpawnEnv</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv&#39;</span><span class="hl-1">;</span><br/><span class="hl-4">import</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">definePlugin</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">readMergedOptions</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">runCommand</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">shouldCapture</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv/cliHost&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">export</span><span class="hl-1"> </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-0">dockerPlugin</span><span class="hl-1"> = () </span><span class="hl-3">=&gt;</span><br/><span class="hl-1">  </span><span class="hl-0">definePlugin</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-5">ns:</span><span class="hl-1"> </span><span class="hl-2">&#39;docker&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">setup</span><span class="hl-1">(</span><span class="hl-5">cli</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">cli</span><span class="hl-1">.</span><span class="hl-0">argument</span><span class="hl-1">(</span><span class="hl-2">&#39;[args...]&#39;</span><span class="hl-1">).</span><span class="hl-0">action</span><span class="hl-1">(</span><span class="hl-3">async</span><span class="hl-1"> (</span><span class="hl-5">args</span><span class="hl-1">, </span><span class="hl-5">_opts</span><span class="hl-1">, </span><span class="hl-5">thisCommand</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">bag</span><span class="hl-1"> = </span><span class="hl-0">readMergedOptions</span><span class="hl-1">(</span><span class="hl-5">thisCommand</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">ctx</span><span class="hl-1"> = </span><span class="hl-5">cli</span><span class="hl-1">.</span><span class="hl-0">getCtx</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">env</span><span class="hl-1"> = </span><span class="hl-0">buildSpawnEnv</span><span class="hl-1">(</span><span class="hl-5">process</span><span class="hl-1">.</span><span class="hl-5">env</span><span class="hl-1">, </span><span class="hl-5">ctx</span><span class="hl-1">.</span><span class="hl-5">dotenv</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-7">// Choose shell behavior: explicit false (plain), or inherit the normalized root shell</span><br/><span class="hl-1">        </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">shell</span><span class="hl-1"> = </span><span class="hl-5">bag</span><span class="hl-1">.</span><span class="hl-5">shell</span><span class="hl-1"> ?? </span><span class="hl-3">false</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">capture</span><span class="hl-1"> = </span><span class="hl-0">shouldCapture</span><span class="hl-1">(</span><span class="hl-5">bag</span><span class="hl-1">.</span><span class="hl-5">capture</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-7">// Shell-off: prefer argv arrays to preserve payloads</span><br/><span class="hl-1">        </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">argv</span><span class="hl-1"> = [</span><br/><span class="hl-1">          </span><span class="hl-2">&#39;docker&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          ...(</span><span class="hl-5">Array</span><span class="hl-1">.</span><span class="hl-0">isArray</span><span class="hl-1">(</span><span class="hl-5">args</span><span class="hl-1">) ? </span><span class="hl-5">args</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(</span><span class="hl-5">String</span><span class="hl-1">) : []),</span><br/><span class="hl-1">        ];</span><br/><span class="hl-1">        </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">commandArg</span><span class="hl-1"> = </span><span class="hl-5">shell</span><span class="hl-1"> === </span><span class="hl-3">false</span><span class="hl-1"> ? </span><span class="hl-5">argv</span><span class="hl-1"> : </span><span class="hl-5">argv</span><span class="hl-1">.</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-2">&#39; &#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">runCommand</span><span class="hl-1">(</span><span class="hl-5">commandArg</span><span class="hl-1">, </span><span class="hl-5">shell</span><span class="hl-1"> === </span><span class="hl-3">false</span><span class="hl-1"> ? </span><span class="hl-3">false</span><span class="hl-1"> : </span><span class="hl-5">shell</span><span class="hl-1">, {</span><br/><span class="hl-1">          </span><span class="hl-5">env</span><span class="hl-1">,</span><br/><span class="hl-1">          </span><span class="hl-5">stdio:</span><span class="hl-1"> </span><span class="hl-5">capture</span><span class="hl-1"> ? </span><span class="hl-2">&#39;pipe&#39;</span><span class="hl-1"> : </span><span class="hl-2">&#39;inherit&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">      });</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  });</span>
</code><button type="button">Copy</button></pre>

<p>Notes:</p>
<ul>
<li>Use <code>shell: false</code> for simpler, safer argv flows; flip to the root shell only when you need shell parsing.</li>
<li>Build <code>env</code> with <code>buildSpawnEnv</code>.</li>
<li>Honor capture for CI determinism.</li>
</ul>
<h3 id="clidriven-scripts-optional-rare-perscript-override" class="tsd-anchor-link">CLI‑driven (scripts optional, rare per‑script override)<a href="#clidriven-scripts-optional-rare-perscript-override" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">buildSpawnEnv</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv&#39;</span><span class="hl-1">;</span><br/><span class="hl-4">import</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">definePlugin</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">maybePreserveNodeEvalArgv</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">readMergedOptions</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">resolveCommand</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">resolveShell</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">runCommand</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">shouldCapture</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-5">ScriptsTable</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/get-dotenv/cliHost&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">export</span><span class="hl-1"> </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-0">runPlugin</span><span class="hl-1"> = () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">plugin</span><span class="hl-1"> = </span><span class="hl-0">definePlugin</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-5">ns:</span><span class="hl-1"> </span><span class="hl-2">&#39;run&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-0">setup</span><span class="hl-1">(</span><span class="hl-5">cli</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">cli</span><br/><span class="hl-1">        .</span><span class="hl-0">argument</span><span class="hl-1">(</span><span class="hl-2">&#39;[command...]&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">        .</span><span class="hl-0">action</span><span class="hl-1">(</span><span class="hl-3">async</span><span class="hl-1"> (</span><span class="hl-5">commandParts</span><span class="hl-1">, </span><span class="hl-5">_opts</span><span class="hl-1">, </span><span class="hl-5">thisCommand</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">bag</span><span class="hl-1"> = </span><span class="hl-0">readMergedOptions</span><span class="hl-1">(</span><span class="hl-5">thisCommand</span><span class="hl-1">);</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">ctx</span><span class="hl-1"> = </span><span class="hl-5">cli</span><span class="hl-1">.</span><span class="hl-0">getCtx</span><span class="hl-1">();</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">env</span><span class="hl-1"> = </span><span class="hl-0">buildSpawnEnv</span><span class="hl-1">(</span><span class="hl-5">process</span><span class="hl-1">.</span><span class="hl-5">env</span><span class="hl-1">, </span><span class="hl-5">ctx</span><span class="hl-1">.</span><span class="hl-5">dotenv</span><span class="hl-1">);</span><br/><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">input</span><span class="hl-1"> = </span><span class="hl-5">Array</span><span class="hl-1">.</span><span class="hl-0">isArray</span><span class="hl-1">(</span><span class="hl-5">commandParts</span><span class="hl-1">)</span><br/><span class="hl-1">            ? </span><span class="hl-5">commandParts</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(</span><span class="hl-5">String</span><span class="hl-1">).</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-2">&#39; &#39;</span><span class="hl-1">)</span><br/><span class="hl-1">            : </span><span class="hl-2">&#39;&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">          </span><span class="hl-4">if</span><span class="hl-1"> (!</span><span class="hl-5">input</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&#39;Provide a script name or a raw command&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">            </span><span class="hl-4">return</span><span class="hl-1">;</span><br/><span class="hl-1">          }</span><br/><span class="hl-1">          </span><span class="hl-7">// Prefer plugin-scoped scripts first (rare), then optionally fall back to root scripts</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> { </span><span class="hl-5">scripts</span><span class="hl-1">: </span><span class="hl-6">pluginScripts</span><span class="hl-1"> } = </span><span class="hl-5">plugin</span><span class="hl-1">.</span><span class="hl-0">readConfig</span><span class="hl-1">&lt;{</span><br/><span class="hl-1">            </span><span class="hl-5">scripts</span><span class="hl-1">?: </span><span class="hl-14">ScriptsTable</span><span class="hl-1">;</span><br/><span class="hl-1">          }&gt;(</span><span class="hl-5">cli</span><span class="hl-1">);</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">rootScripts</span><span class="hl-1"> = </span><span class="hl-5">bag</span><span class="hl-1">.</span><span class="hl-5">scripts</span><span class="hl-1">;</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">scripts</span><span class="hl-1"> = </span><span class="hl-5">pluginScripts</span><span class="hl-1"> ?? </span><span class="hl-5">rootScripts</span><span class="hl-1">;</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">resolvedCmd</span><span class="hl-1"> = </span><span class="hl-0">resolveCommand</span><span class="hl-1">(</span><span class="hl-5">scripts</span><span class="hl-1">, </span><span class="hl-5">input</span><span class="hl-1">);</span><br/><br/><span class="hl-1">          </span><span class="hl-7">// Precedence: per-script shell (object form) &gt; root shell</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">shell</span><span class="hl-1"> = </span><span class="hl-0">resolveShell</span><span class="hl-1">(</span><span class="hl-5">scripts</span><span class="hl-1">, </span><span class="hl-5">input</span><span class="hl-1">, </span><span class="hl-5">bag</span><span class="hl-1">.</span><span class="hl-5">shell</span><span class="hl-1">);</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">capture</span><span class="hl-1"> = </span><span class="hl-0">shouldCapture</span><span class="hl-1">(</span><span class="hl-5">bag</span><span class="hl-1">.</span><span class="hl-5">capture</span><span class="hl-1">);</span><br/><br/><span class="hl-1">          </span><span class="hl-7">// Preserve argv only when shell-off and the command wasn&#39;t remapped by scripts.</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">argvIn</span><span class="hl-1"> = </span><span class="hl-5">Array</span><span class="hl-1">.</span><span class="hl-0">isArray</span><span class="hl-1">(</span><span class="hl-5">commandParts</span><span class="hl-1">)</span><br/><span class="hl-1">            ? </span><span class="hl-5">commandParts</span><span class="hl-1">.</span><span class="hl-0">map</span><span class="hl-1">(</span><span class="hl-5">String</span><span class="hl-1">)</span><br/><span class="hl-1">            : [];</span><br/><span class="hl-1">          </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-6">commandArg</span><span class="hl-1"> =</span><br/><span class="hl-1">            </span><span class="hl-5">shell</span><span class="hl-1"> === </span><span class="hl-3">false</span><span class="hl-1"> &amp;&amp; </span><span class="hl-5">resolvedCmd</span><span class="hl-1"> === </span><span class="hl-5">input</span><br/><span class="hl-1">              ? </span><span class="hl-0">maybePreserveNodeEvalArgv</span><span class="hl-1">(</span><span class="hl-5">argvIn</span><span class="hl-1">)</span><br/><span class="hl-1">              : </span><span class="hl-5">resolvedCmd</span><span class="hl-1">;</span><br/><br/><span class="hl-1">          </span><span class="hl-4">await</span><span class="hl-1"> </span><span class="hl-0">runCommand</span><span class="hl-1">(</span><span class="hl-5">commandArg</span><span class="hl-1">, </span><span class="hl-5">shell</span><span class="hl-1">, {</span><br/><span class="hl-1">            </span><span class="hl-5">env</span><span class="hl-1">,</span><br/><span class="hl-1">            </span><span class="hl-5">stdio:</span><span class="hl-1"> </span><span class="hl-5">capture</span><span class="hl-1"> ? </span><span class="hl-2">&#39;pipe&#39;</span><span class="hl-1"> : </span><span class="hl-2">&#39;inherit&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">          });</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">  </span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-5">plugin</span><span class="hl-1">;</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<p>Notes:</p>
<ul>
<li>Commands typed at the CLI may be a script name or a raw command.</li>
<li>Prefer plugin‑scoped <code>plugins.&lt;mount-path&gt;.scripts</code> for clarity; fall back to root scripts when it’s helpful.</li>
<li>Rarely, the object form <code>{ cmd, shell }</code> lets a single script request a different shell; otherwise the root shell applies.</li>
</ul>
<p>See also:</p>
<ul>
<li><a href="Guides.Shell_execution_behavior.html">Shell Execution Behavior</a></li>
<li><a href="Guides.Authoring_Plugins.Diagnostics___Errors.html">Diagnostics</a></li>
</ul>
<h2 id="typescript-notes" class="tsd-anchor-link">TypeScript notes<a href="#typescript-notes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h2><ul>
<li>A helper <code>defineScripts&lt;TShell&gt;()(table)</code> is available when you want to preserve concrete shell types through your scripts table (useful for rare per‑script overrides).</li>
<li>Env overlay/expansion utilities accept readonly record inputs, so you can pass <code>as const</code> objects where it improves inference without extra casts.</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="../assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#authoring-plugins-executing-shell-commands"><span>Authoring <wbr/>Plugins: <wbr/>Executing <wbr/>Shell <wbr/>Commands</span></a><ul><li><a href="#where-expansion-happens"><span>Where expansion happens</span></a></li><li><ul><li><a href="#expanding-environment-references-in-plugin-flag-values"><span>Expanding environment references in plugin flag values</span></a></li><li><ul><li><a href="#action-time-expansion-ctx-aware-recommended"><span>Action-<wbr/>time expansion (ctx-<wbr/>aware; recommended)</span></a></li><li><a href="#using-dotenvexpand-as-an-option-parser-when-it-is-and-isnt-appropriate"><span>Using dotenv<wbr/>Expand as an option parser (when it is and isn’t appropriate)</span></a></li><li><ul><li><a href="#small-reusable-helper-docs-pattern"><span>Small reusable helper (docs pattern)</span></a></li><li><a href="#arrays-and-deep-structures-"><span>Arrays and deep structures:  + </span></a></li></ul></li><li><a href="#cli-usage-examples-and-quoting-portable"><span>CLI usage examples and quoting (portable)</span></a></li></ul></li></ul></li><li><a href="#shell-selection-and-precedence"><span>Shell selection and precedence</span></a></li><li><a href="#child-environment-composition-required"><span>Child environment composition (required)</span></a></li><li><a href="#capture-and-diagnostics"><span>Capture and diagnostics</span></a></li><li><a href="#quoting-and-argv-vs-string"><span>Quoting and argv vs string</span></a></li><li><ul><li><a href="#preserve-node-argv-under-shelloff"><span>Preserve <wbr/>Node  argv under shell‑off</span></a></li></ul></li><li><a href="#doubleexpansion-and-safety"><span>Double‑expansion and safety</span></a></li><li><a href="#minimal-patterns"><span>Minimal patterns</span></a></li><li><ul><li><a href="#toolinvocation-no-scripts"><span>Tool‑invocation (no scripts)</span></a></li><li><a href="#clidriven-scripts-optional-rare-perscript-override"><span>CLI‑driven (scripts optional, rare per‑script override)</span></a></li></ul></li><li><a href="#typescript-notes"><span>Type<wbr/>Script notes</span></a></li></ul></div></details></div><div class="site-menu"><nav id="tsd-sidebar-links" class="tsd-navigation"><a href="https://github.com/karmaniverous/get-dotenv" class="tsd-nav-link">GitHub</a></nav><nav class="tsd-navigation"><a href="../modules.html">@karmaniverous/get-dotenv</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
